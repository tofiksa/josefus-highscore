name: 'Migrate database schema'

on:
  push:
    branches:
      - main

jobs:
  migrate-database:
    name: Run Flyway migrations
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres
        env:
          SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
          SUPABASE_PORT: ${{ secrets.SUPABASE_PORT }}
          SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
          SUPABASE_DB: ${{ secrets.SUPABASE_DB }}
    steps:
      - uses: actions/checkout@v2
      - uses: joshuaavalon/flyway-action@v3.0.0
        with:
          url: ${{ secrets.SUPABASE_HOST }}
          user: ${{ secrets.SUPABASE_USER }}
          password: ${{ secrets.SUPABASE_PASS }}
          database: ${{ secrets.SUPABASE_DB }}
          locations: filesystem:./src/main/resources/db.migration
      - run: echo 'deploying to prod'
